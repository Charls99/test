{% from "sidebar.html" import sidebar%}
{% from "header.html" import header%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="GenIT Bangladesh">
    <!-- Favicon icon -->
    <link rel="icon" type="image/ico" sizes="16x16" href="static/assets/images/favicn.ico">
    <title>H R System (CI)</title>
    <!-- Bootstrap Core CSS -->
    <link href="static/assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- morris CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/2.0.46/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="static/assets/plugins/morrisjs/morris.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="static/assets/plugins/bootstrap-material-datetimepicker/css/bootstrap-material-datetimepicker.css" rel="stylesheet">

    <link href="static/assets/css/style.css" rel="stylesheet" media="all">
    <link href="static/assets/css/print.css" rel="stylesheet" media='print'>
    <!-- You can change the theme colors from here -->
    <link href="static/assets/css/colors/blue.css" id="theme" rel="stylesheet">
    <link href="static/assets/plugins/select2/dist/css/select2.min.css" rel="stylesheet" type="text/css" />
    <link href="static/assets/plugins/switchery/dist/switchery.min.css" rel="stylesheet" />
    <link href="static/assets/plugins/bootstrap-select/bootstrap-select.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css" rel="stylesheet" type="text/css" />
    <link href="static/assets/plugins/clockpicker/dist/jquery-clockpicker.min.css" rel="stylesheet">
    <!-- Daterange picker plugins css -->
    <link href="static/assets/plugins/timepicker/bootstrap-timepicker.min.css" rel="stylesheet">

    <script src="static/assets/plugins/jquery/jquery.min.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js"></script>
    <link href="static/assets/plugins/multiselect/css/multi-select.css" rel="stylesheet" type="text/css" />
    <link href="static/assets/plugins/calendar/dist/fullcalendar.css" rel="stylesheet" type="text/css" />
</head>

<body class="fix-header fix-sidebar card-no-border">
    <div class="preloader">
        <svg class="circular" viewBox="25 25 50 50">
            <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10" />
        </svg>
    </div>
    <div id="main-wrapper">
        <header class="topbar">
            {{ header() }}
        </header>
        <aside class="left-sidebar">
            <!-- Sidebar scroll-->
            {{ sidebar() }}
            <!-- End Sidebar scroll-->
        </aside><div class="page-wrapper">
            <div class="message">
            </div>
            <div class="row page-titles">
                <div class="col-md-5 align-self-center">
                    <h3 class="text-themecolor">
                        <i class="fa fa-money"></i> Payroll View
                    </h3>
                </div>
                <div class="col-md-7 align-self-center">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="javascript:void(0)">
                                Home
                            </a>
                        </li>
                        <li class="breadcrumb-item active">
                            Payroll View
                        </li>
                    </ol>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row m-b-10">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary">
                            <i class="fa fa-bars">
                            </i>
                            <a href="{{url_for('salaryList')}}" class="text-white">
                                <i class="" aria-hidden="true">
                                </i>   Payroll List
                            </a>
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card card-outline-info">
                            <div class="card-header">
                                <h4 class="m-b-0 text-white">
                                    Monthly Salary Arrangement
                                </h4>
                            </div>
                            <div class="card-body">
                                <!--Savd vdgff gdfg dfg dfgdfg df  gd gdd gfd-->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <form method="post" action="pay_salary_add_record" id="generatePayrollForm" enctype="multipart/form-data">
                                                    <div class="modal-body">
                                                        <div class="form-group row">
                                                            <label class="control-label text-left col-md-3">Employee</label>
                                                            <div class="col-md-9">
                                                                <select class="form-control custom-select" data-placeholder="Choose a Category" id="emid" tabindex="1" name="emid" id="OnEmValue" required>
                                                                    <option value="#"> Select Here</option>
                                                                    {% for emp in allemp %}
                                                                    <option value="{{ emp[2] }}">{{ emp[0] }} {{ emp[1] }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="form-group row">
                                                            <label class="control-label text-left col-md-3">
                                                                Month
                                                            </label>
                                                            <div class="col-md-9">
                                                                <label>Pay Date: </label>
                                                                <div id="" class="input-group date">
                                                                    <input name="paydate" class="form-control mydatetimepickerFull" value="" required>
                                                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="form-group row">
                                                                    <label class="control-label text-left col-md-5">
                                                                        Basic Salary
                                                                    </label>
                                                                    <div class="col-md-7">
                                                                        <input type="text" name="basic" class="form-control" id="" value="">
                                                                    </div>
                                                                </div>
                                                                <div class="form-group row">
                                                                    <label class="control-label text-left col-md-5">
                                                                        Working hours
                                                                    </label>
                                                                    <div class="col-md-7">
                                                                        <input type="text" name="month_work_hours" class="form-control thour" value="" readonly>
                                                                    </div>
                                                                </div>
                                                                <div class="form-group row">
                                                                    <label class="control-label text-left col-md-5">
                                                                        Hours worked
                                                                    </label>
                                                                    <div class="col-md-7">
                                                                        <input type="text" name="hours_worked" class="form-control hours_worked" id="" value="">
                                                                        <span>Work Without Pay:</span><span class="wpay"></span> <span>hrs</span>
                                                                    </div>
                                                                </div>
                                                                <div class="form-group row" style="display:none">
                                                                    <label class="control-label text-left col-md-5">
                                                                    </label>
                                                                    <div class="col-md-7">
                                                                        <input type="hidden" name="hrate" class="form-control hrate" id="hrate" value=''>
                                                                    </div>
                                                                </div>
                                                                <div class="form-group row" id="addition">
                                                                    <label class="control-label text-left col-md-5">
                                                                        Addition
                                                                    </label>
                                                                    <div class="col-md-7">
                                                                        <input type="text" name="addition" class="form-control" id="" value="">
                                                                    </div>
                                                                </div>
                                                                <div class="form-group row">
                                                                    <label class="control-label text-left col-md-5">
                                                                        Pay Date
                                                                    </label>
                                                                    <div class="col-md-7">
                                                                        <input type="text" name="paydate" class="form-control mydatetimepickerFull" id="" value="" required>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="form-group row" id="diduction">
                                                                    <label class="control-label text-left col-md-5">
                                                                        Deduction
                                                                    </label>
                                                                    <div class="col-md-7">
                                                                        <input type="text" name="diduction" class="form-control diduction" id="" value="">
                                                                    </div>
                                                                </div>
                                                                <div class="form-group row" id="loan">
                                                                    <label class="control-label text-left col-md-5">
                                                                        Loan
                                                                    </label>
                                                                    <div class="col-md-7">
                                                                        <input type="text" name="loan" class="form-control loan" id="" value="">
                                                                    </div>
                                                                </div>
                                                                <div class="form-group row">
                                                                    <label class="control-label text-left col-md-5">
                                                                        Final Salary
                                                                    </label>
                                                                    <div class="col-md-7">
                                                                        <input type="text" name="total_paid" class="form-control total_paid" id="" value="" required>
                                                                    </div>
                                                                </div>
                                                                <div class="form-group row">
                                                                    <label class="control-label text-left col-md-5">Status</label><br>
                                                                    <div class="col-md-7">
                                                                        <input name="status" type="radio" id="radio_1" data-value="Paid" class="duration" value="Paid" checked="checked">
                                                                        <label for="radio_1">Paid</label>
                                                                        <input name="status" type="radio" id="radio_2" data-value="Process" class="type" value="Process">
                                                                        <label for="radio_2">Process</label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="form-group row" style="margin-top: 25px;">
                                                            <label class="control-label text-left col-md-3">Paid Type</label><br>
                                                            <div class="col-md-9">
                                                                <input name="paid_type" type="radio" id="radio_3" data-value="Hand Cash" class="" value="Hand Cash" checked="checked">
                                                                <label for="radio_3" style="margin-left: 30px">Hand Cash</label>
                                                                <input name="paid_type" type="radio" id="radio_4" data-value="Bank" class="type" value="Bank">
                                                                <label for="radio_4" style="margin-left: 130px">Bank</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <input type="hidden" name="action" value="add" class="form-control" id="formAction">
                                                        <input type="hidden" name="loan_id" value="" class="form-control" id="loanID">
                                                        <button type="button" class="btn btn-danger" data-dismiss="modal">
                                                            Close
                                                        </button>
                                                        <button type="submit" class="btn btn-success">
                                                            Submit
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--Savd vdgff gdfg dfg dfgdfg df  gd gdd gfd-->
                                <div class="table-responsive ">
                                    <table id="example23" class="display nowrap table table-hover table-striped table-bordered" cellspacing="0" width="100%">
                                        <thead>
                                            <tr>
                                                <th>
                                                    PIN
                                                </th>
                                                <th>
                                                    Full name
                                                </th>
                                                <th>
                                                    Total salary
                                                </th>
                                                <th>
                                                    Action
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="payroll"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <script>
        // Populate the payroll table to generate the payroll for each individual
      $("#BtnSubmit").on("click", function(event){
        event.preventDefault();
        var depid = $('#depid').val();
        var datetime = $('.mydatetimepicker').val();

        $.ajax({
          url: "load_employee_by_deptID_for_pay?date_time="+datetime+"&dep_id="+depid,
          type:"GET",
          dataType:'',
          data:'data',
          success: function(response) {
            // console.log(response);
            $('.payroll').html(response);
          },
          error: function(response) {

          }
        });
      });
                </script>

                <div class="modal fade" id="generatePayrollModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel1">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content ">
                            <div class="modal-header">
                                <h4 class="modal-title" id="">
                                    Salary Arrangement
                                </h4>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">
                                        &times;
                                    </span>
                                </button>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <script type="text/javascript">
          $(document).ready(function () {
          $(document).on('keyup','.hours_worked',function() {
            var finalsalary = 0;
            //var total;
            var deduction = 0;
            var rows = this.closest('#generatePayrollForm div');

            var hrate = parseFloat($('.hrate').val());
            var final =parseFloat($('.total_paid').val());
            var loan = parseFloat($('.loan').val());
            var hwork =parseFloat($('.hours_worked').val());
            var thour =parseFloat($('.thour').val());

              finalsalary = (hwork*hrate) - loan;
              $(".total_paid").val(finalsalary.toFixed(2));
              var total = thour - hwork;
              var deduction = (total*hrate) + loan;
              $(".diduction").val(deduction.toFixed(2));
              $(".wpay").html(total.toFixed(2));

              console.log(loan);
           // var returnval;
              //returnval = payval - payableval;
/*            if(returnval<=0){
                  $(".due").val(Math.abs(returnval).toFixed(2));
              }else if(returnval > 0){
                 $(".due").val('');
              }
              $(".return").val(returnval.toFixed(2));*/

          });
        });
                </script>
                <script type="text/javascript">
    // Populate salary data on generate salary click
      $(document).ready(function () {

        $(document).on('click', ".salaryGenerateModal", function (e) {
          e.preventDefault(e);

          $('#generatePayrollModal').modal('show');

          var emid = $(this).data('id');
          var month = $(this).data('month');
          var year = $(this).data('year');
          var has_loan = $(this).data('has_loan');

          console.log(has_loan);

          $('#generatePayrollForm').find('[name="emid"]').val(emid).attr('readonly', true).end();
          $('#generatePayrollForm').find('[name="month"]').val(Math.abs(month)).attr('readonly', true).end();

          $.ajax({
            url: 'generate_payroll_for_each_employee?month='+month+'&year='+year+'&employeeID='+emid,
            method: 'GET',
            data: '',
            dataType: 'json',
          }).done(function (response) {
            console.log(response);

            if(response.addition == 0) {
                $('#generatePayrollForm').find('[id="addition"]').val('').hide().end();
            }
            if(response.diduction == 0) {
                $('#generatePayrollForm').find('[id="diduction"]').val('').hide().end();
            }
            if(response.loan == 0) {
                $('#generatePayrollForm').find('[id="loan"]').val('').hide().end();
            }

            $('#generatePayrollForm').find('[name="basic"]').val(response.basic_salary).attr('readonly', true).end();
            $('#generatePayrollForm').find('[name="month_work_hours"]').val(response.total_work_hours).attr('readonly', true).end();
            $('#generatePayrollForm').find('[name="hours_worked"]').val(response.employee_actually_worked)/*.attr('readonly', true)*/.end();
            $('#generatePayrollForm').find('[name="addition"]').val(response.addition).end();
            $('#generatePayrollForm').find('[name="diduction"]').val(response.diduction).end();
            $('#generatePayrollForm').find('[class="wpay"]').html(response.wpay).end();
            $('#generatePayrollForm').find('[name="loan"]').val(response.loan_amount).prop('readonly', true).end();
            $('#generatePayrollForm').find('[name="loan_id"]').val(response.loan_id).end();
            $('#generatePayrollForm').find('[name="total_paid"]').val(response.final_salary).end();
            $('#generatePayrollForm').find('[name="year"]').val(year).end();
            $('#generatePayrollForm').find('[name="hrate"]').val(response.rate).end();
      });
});
        });
                </script>
            </div>

            <footer class="footer"> © 2022 | Developed By GenIT Bangladesh </footer>

        </div>

    </div>


    <!-- Bootstrap tether Core JavaScript -->
    <script src="static/assets/plugins/bootstrap/js/popper.min.js"></script>
    <script src="static/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <!-- slimscrollbar scrollbar JavaScript -->
    <script src="static/assets/js/jquery.slimscroll.js"></script>
    <!--Wave Effects -->
    <script src="static/assets/js/waves.js"></script>
    <!--Menu sidebar -->
    <script src="static/assets/js/sidebarmenu.js"></script>
    <!--stickey kit -->
    <script src="static/assets/plugins/sticky-kit-master/dist/sticky-kit.min.js"></script>
    <!--Custom JavaScript -->
    <script src="static/assets/js/custom.min.js"></script>

    <!-- ============================================================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>
    <!-- ============================================================== -->
    <!--sparkline JavaScript -->
    <script src="static/assets/plugins/sparkline/jquery.sparkline.min.js"></script>
    <!--morris JavaScript -->
    <script src="static/assets/plugins/raphael/raphael-min.js"></script>
    <script src="static/assets/plugins/morrisjs/morris.js"></script>
    <!-- Chart JS -->
    <!-- CHART COMMENTED....UNCOMMENT WHEN DONE -->
    <!-- <script src="static/assets/js/dashboard1.js"></script> -->





    <script src="static/assets/plugins/moment/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>

    <script src="static/assets/plugins/styleswitcher/jQuery.style.switcher.js"></script>

    <!-- Editable -->
    <script src="static/assets/plugins/jsgrid/db.js"></script>
    <script type="text/javascript" src="static/assets/plugins/jsgrid/dist/jsgrid.min.js"></script>
    <!-- This is data table -->

    <script type="text/javascript" src="static/assets/plugins/multiselect/js/jquery.multi-select.js"></script>
    <script src="static/assets/plugins/datatables/jquery.dataTables.min.js"></script>
    <!-- start - This is for export functionality only -->
    <script src="static/assets/export/cdn.datatables.net/buttons/1.2.2/js/dataTables.buttons.min.js"></script>
    <script src="static/assets/export/cdn.datatables.net/buttons/1.2.2/js/buttons.flash.min.js"></script>
    <script src="static/assets/export/cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
    <script src="static/assets/export/cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/pdfmake.min.js"></script>
    <script src="static/assets/export/cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js"></script>
    <script src="static/assets/export/cdn.datatables.net/buttons/1.2.2/js/buttons.html5.min.js"></script>
    <script src="static/assets/export/cdn.datatables.net/buttons/1.2.2/js/buttons.print.min.js"></script>


    <!-- Clock Plugin JavaScript -->
    <script src="static/assets/plugins/clockpicker/dist/jquery-clockpicker.min.js"></script>
    <!-- Date range Plugin JavaScript -->
    <script src="static/assets/plugins/timepicker/bootstrap-timepicker.min.js"></script>
    <script src="static/assets/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- end - This is for export functionality only -->
    <script src="static/assets/plugins/select2/dist/js/select2.full.min.js" type="text/javascript"></script>
    <script src="static/assets/plugins/bootstrap-select/bootstrap-select.min.js" type="text/javascript"></script>
    <script src="static/assets/plugins/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="static/assets/plugins/multiselect/js/jquery.multi-select.js"></script>




    <!-- CALENDAR -->
    <!-- <script type="text/javascript" src="static/assets/plugins/calendar/jquery-ui.min.js"></script> -->
    <script type="text/javascript" src="static/assets/plugins/calendar/dist/fullcalendar.min.js"></script>
    <script type="text/javascript" src="static/assets/plugins/calendar/dist/cal-init.js"></script>

    <script type="text/javascript">
        $(function () {
            $('.mydatetimepicker').datepicker({
            format: "mm-yyyy",
            viewMode: "years",
            minViewMode: "months"
            });
        });
        $(function () {
            $('.mydatetimepickerFull').datepicker({
            format: "yyyy-mm-dd"
            });
        });
    </script>
    <script>
    $(document).ready(function() {
        $('#myTable').DataTable();
        $(document).ready(function() {
            var table = $('#example').DataTable({
                "columnDefs": [{
                    "visible": false,
                    "targets": 2
                }],
                "order": [
                    [2, 'asc']
                ],
                "displayLength": 25,
                "drawCallback": function(settings) {
                    var api = this.api();
                    var rows = api.rows({
                        page: 'current'
                    }).nodes();
                    var last = null;
                    api.column(2, {
                        page: 'current'
                    }).data().each(function(group, i) {
                        if (last !== group) {
                            $(rows).eq(i).before('<tr class="group"><td colspan="5">' + group + '</td></tr>');
                            last = group;
                        }
                    });
                }
            });
            // Order by the grouping
            $('#example tbody').on('click', 'tr.group', function() {
                var currentOrder = table.order()[0];
                if (currentOrder[0] === 2 && currentOrder[1] === 'asc') {
                    table.order([2, 'desc']).draw();
                } else {
                    table.order([2, 'asc']).draw();
                }
            });
        });
    });
    $(function () {
  $("#datepicker").datepicker({
        autoclose: true,
        todayHighlight: true
  }).datepicker('update', new Date());
});
    jQuery('.mydatepicker, #datepicker').datepicker();
    jQuery('#datepicker-autoclose').datepicker({
        autoclose: true,
        todayHighlight: true
    });
    $('#example23').DataTable({
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
    });
    $('#single-input').clockpicker({
        placement: 'bottom',
        align: 'left',
        autoclose: true,
        'default': 'now'
    });
    $('#single-input').clockpicker({
        placement: 'bottom',
        align: 'left',
        autoclose: true,
        'default': 'now'
    });
    $('.clockpicker').clockpicker({
        donetext: 'Done',
    }).find('input').change(function() {
        console.log(this.value);
    });
    $('#check-minutes').click(function(e) {
        // Have to stop propagation here
        e.stopPropagation();
        input.clockpicker('show').clockpicker('toggleView', 'minutes');
    });




    $(function() {
    $('#datetimepicker2').datetimepicker({
      language: 'en',
      pick12HourFormat: true
    });
  });

    $(".select2").select2();
    </script>

    <script src="static/assets/plugins/styleswitcher/jQuery.style.switcher.js"></script>
</body>

</html>
